{% extends "base_mentor.html" %}

{% block title %}STL Admin - Gestão de Mentoria{% endblock %}

{% block content %}
<section id="section-admin-welcome" aria-label="section"
  data-bgimage="url({{ url_for('static', filename='images/background/bg-1.jpg') }}) top"
  data-stellar-background-ratio=".2">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-12 text-center">
        <div class="spacer-double"></div>
        <h4 class="s1 id-color">Gestão Executiva</h4>
        <div class="spacer-10"></div>
        <h2 class="wow fadeInUp" data-wow-delay=".6s">Painel do Mentor</h2>
        <div class="spacer-double"></div>
      </div>
    </div>
  </div>
</section>

<section class="bg-light pt-4 pb-5">
  <div class="container">

    <ul class="nav nav-pills nav-fill flex-column flex-md-row mb-4 gap-2 custom-pills" id="pills-tab" role="tablist">
      <li class="nav-item">
        <button class="nav-link active w-100" id="pills-users-tab" data-bs-toggle="pill" data-bs-target="#pills-users"
          type="button">
          <i class="fa fa-users me-2"></i>Mentorados
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link w-100" id="pills-tasks-tab" data-bs-toggle="pill" data-bs-target="#pills-tasks"
          type="button">
          <i class="fa fa-folder-open me-2"></i>Tarefas
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link w-100" id="pills-agenda-tab" data-bs-toggle="pill" data-bs-target="#pills-agenda"
          type="button">
          <i class="fa fa-calendar me-2"></i>Minha Agenda
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link w-100" id="pills-resources-tab" data-bs-toggle="pill" data-bs-target="#pills-resources"
          type="button">
          <i class="fa fa-book me-2"></i>Materiais
        </button>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">

      <div class="tab-pane fade show active" id="pills-users">
        <div class="card shadow-sm border-0">
          <div class="card-body p-2 p-md-4">
            <h5 class="card-title mb-3">Base de Alunos</h5>
            <div class="table-responsive">
              <table class="table table-hover align-middle" style="min-width: 600px;">
                <thead class="table-light">
                  <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Ação</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in mentees %}
                  <tr>
                    <td class="fw-bold">{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td><span class="badge {{ 'bg-success' if user.active else 'bg-danger' }}">{{ 'Ativo' if user.active
                        else 'Inativo' }}</span></td>
                    <td><a href="{{ url_for('admin.toggle_user_status', user_id=user.id) }}"
                        class="btn btn-sm btn-light border"><i class="fa fa-power-off"></i></a></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pills-tasks">
        <div class="card shadow-sm border-0">
          <div class="card-body p-2 p-md-4">

            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title m-0">Entregas dos Alunos</h5>
              <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#manageTasksModal">
                <i class="fa fa-cogs me-1"></i> Configurar Módulos
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle" style="min-width: 700px;">
                <thead class="table-light small text-uppercase">
                  <tr>
                    <th>Aluno</th>
                    <th>Atividade</th>
                    <th>Enviado em</th>
                    <th class="text-end pe-3">Arquivo</th>
                  </tr>
                </thead>
                <tbody>
                  {% for task in recent_tasks %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <div
                          class="avatar-circle me-2 bg-light text-primary fw-bold d-flex align-items-center justify-content-center rounded-circle border"
                          style="width: 35px; height: 35px;">
                          {{ task.user.username[0]|upper }}
                        </div>
                        <div>
                          <div class="fw-bold text-dark">{{ task.user.username }}</div>
                          <div class="small text-muted">{{ task.user.email }}</div>
                        </div>
                      </div>
                    </td>

                    <td>
                      <strong>{{ task.task_name }}</strong>
                      <br>
                      <span class="badge bg-light text-dark border">{{ task.module_name }}</span>
                    </td>

                    <td>
                      <div class="text-dark">{{ task.submitted_at.strftime('%d/%m/%Y') }}</div>
                      <small class="text-muted">{{ task.submitted_at.strftime('%H:%M') }}</small>
                    </td>

                    <td class="text-end">
                      {% if task.file_path %}
                      <a href="{{ url_for('admin.download_user_task', task_id=task.id) }}"
                        class="btn btn-sm btn-primary shadow-sm" title="Baixar: {{ task.file_path }}">
                        <i class="fa fa-download me-1"></i> Baixar Entrega
                      </a>
                      {% else %}
                      <span class="badge bg-secondary">Sem arquivo</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="4" class="text-center text-muted py-5">
                      <i class="fa fa-inbox fa-3x mb-3 opacity-25"></i>
                      <br>Nenhuma entrega realizada até o momento.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pills-agenda">
        <div class="row">
          <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-warning text-dark fw-bold">
                <i class="fa fa-clock-o me-2"></i>Aprovar
              </div>
              <div class="card-body p-0">
                {% if pending_appointments %}
                <div class="list-group list-group-flush">
                  {% for appt in pending_appointments %}
                  <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div><strong>{{ appt.user.username }}</strong></div>
                      {% if 'Atualizado' in appt.status %}<span class="badge bg-info text-dark">Alterado</span>{% endif
                      %}
                    </div>
                    <div class="alert alert-light border p-2 mb-2 small">
                      <i class="fa fa-calendar me-1"></i> {{ appt.schedule_date }}<br>
                    </div>
                    <div class="d-flex gap-2">
                      <a href="{{ url_for('admin.appointment_action', appt_id=appt.id, action='confirm') }}"
                        class="btn btn-sm btn-success flex-grow-1">Aprovar</a>
                      <a href="{{ url_for('admin.appointment_action', appt_id=appt.id, action='reject') }}"
                        class="btn btn-sm btn-outline-danger"><i class="fa fa-times"></i></a>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted small">Nada pendente.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0 h-100">
              <div
                class="card-header bg-white border-bottom-0 d-flex flex-column flex-md-row justify-content-between align-items-center py-3 gap-2">
                <h5 class="mb-0 fw-bold"><i class="fa fa-calendar me-2 text-primary"></i>Gestão da Agenda</h5>
                <button class="btn btn-success btn-sm fw-bold w-md-auto" data-bs-toggle="modal"
                  data-bs-target="#addAvailabilityModal">
                  <i class="fa fa-plus-circle me-1"></i>Novo Horário
                </button>
              </div>

              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0" style="min-width: 600px;">
                    <thead class="table-light small text-uppercase">
                      <tr>
                        <th class="ps-4">Mentorado</th>
                        <th>Data / Hora</th>
                        <th>Status</th>
                        <th class="text-end pe-4">Ação</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for appt in all_appointments %}
                      <tr>
                        <td class="ps-4 fw-bold">{{ appt.user.username }}</td>
                        <td>{{ appt.schedule_date }}</td>
                        <td>
                          {% if 'Confirmado' in appt.status %}
                          <span
                            class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill">Confirmado</span>
                          {% elif 'Recusado' in appt.status %}
                          <span
                            class="badge bg-danger bg-opacity-10 text-danger border border-danger rounded-pill">Recusado</span>
                          {% else %}
                          <span
                            class="badge bg-warning bg-opacity-10 text-warning border border-warning rounded-pill">Pendente</span>
                          {% endif %}
                        </td>
                        <td class="text-end pe-3">
                          <a href="{{ url_for('admin.appointment_action', appt_id=appt.id, action='reject') }}"
                            class="btn btn-sm btn-link text-danger p-0" title="Cancelar"><i class="fa fa-times"></i></a>
                        </td>
                      </tr>
                      {% else %}
                      <tr>
                        <td colspan="4" class="text-center py-4 text-muted">Histórico vazio.</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pills-resources">
        <div class="card shadow-sm border-0">
          <div class="card-body p-3 p-md-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title m-0">Materiais de Apoio</h5>
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadResourceModal">
                <i class="fa fa-upload me-2"></i>Novo
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light small text-uppercase">
                  <tr>
                    <th>Arquivo</th>
                    <th>Detalhes</th>
                    <th class="text-end pe-3">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for res in resources %}
                  <tr>
                    <td width="50" class="text-center"><i class="fa fa-file-text-o fa-2x text-muted"></i></td>
                    <td>
                      <strong>{{ res.title }}</strong><br>
                      <span class="badge bg-light text-dark">{{ res.module_name }}</span>
                      <small class="text-muted ms-1">{{ res.filename|truncate(20) }}</small>
                    </td>
                    <td class="text-end">
                      <div class="btn-group">
                        <a href="{{ url_for('admin.download_resource', res_id=res.id) }}"
                          class="btn btn-sm btn-outline-secondary" title="Baixar" data-bs-toggle="tooltip"><i
                            class="fa fa-download"></i></a>
                        <a href="{{ url_for('admin.delete_resource', res_id=res.id) }}"
                          class="btn btn-sm btn-outline-danger" title="Excluir" data-bs-toggle="tooltip"
                          onclick="return confirm('Excluir este material?');"><i class="fa fa-trash"></i></a>
                      </div>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="3" class="text-center py-5 text-muted">Nenhum material cadastrado.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<div class="modal fade" id="addAvailabilityModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title fw-bold"><i class="fa fa-calendar-plus-o me-2"></i>Disponibilizar Horário</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">

        <div class="d-flex justify-content-end mb-3">
          <button class="btn btn-sm btn-outline-secondary rounded-pill" data-bs-target="#managementModal"
            data-bs-toggle="modal">
            <i class="fa fa-cog me-1"></i> Gerenciar Locais e Datas
          </button>
        </div>

        <form action="{{ url_for('admin.add_availability') }}" method="POST">
          <div class="mb-3">
            <label class="form-label fw-bold">Data e Hora</label>
            <input type="datetime-local" name="datetime_slot" class="form-control form-control-lg" required>
          </div>
          <div class="mb-4">
            <label class="form-label fw-bold">Local</label>
            <select class="form-select form-select-lg" id="locationSelect" name="location_id"
              onchange="handleLocationChange()" required>
              <option value="" selected disabled>Selecione...</option>
              {% for loc in my_locations %}
              <option value="{{ loc.id }}" data-type="{{ loc.type }}" data-address="{{ loc.address }}">{{ loc.name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div id="dynamicFields" class="mb-4 p-3 bg-light rounded border" style="display:none;">
            <div id="onlineField" class="d-none">
              <label class="form-label text-primary small fw-bold">Link da Reunião</label>
              <input type="url" name="meeting_link" class="form-control" placeholder="https://...">
            </div>
            <div id="presencialField" class="d-none">
              <label class="form-label text-dark small fw-bold">Endereço</label>
              <p class="mb-0 text-muted small" id="addressDisplay">...</p>
            </div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-success btn-lg fw-bold">Confirmar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="managementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold"><i class="fa fa-cogs me-2"></i>Gerenciar Agenda</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <ul class="nav nav-tabs nav-justified" id="manageTab" role="tablist">
          <li class="nav-item"><button class="nav-link active py-3" id="loc-tab" data-bs-toggle="tab"
              data-bs-target="#manage-loc">Meus Locais</button></li>
          <li class="nav-item"><button class="nav-link py-3" id="slots-tab" data-bs-toggle="tab"
              data-bs-target="#manage-slots">Horários Livres</button></li>
        </ul>

        <div class="tab-content p-4">

          <div class="tab-pane fade show active" id="manage-loc">
            <h6 class="text-primary mb-3 fw-bold">Novo Local</h6>
            <form action="{{ url_for('admin.add_location') }}" method="POST" class="mb-4 pb-4 border-bottom">
              <div class="row g-2">
                <div class="col-md-4">
                  <input type="text" name="loc_name" class="form-control" placeholder="Nome (Ex: Google Meet)" required>
                </div>
                <div class="col-md-3">
                  <select name="loc_type" class="form-select" id="manageLocType" onchange="toggleManageAddress()">
                    <option value="presencial">Presencial</option>
                    <option value="online">Online</option>
                  </select>
                </div>
                <div class="col-md-5" id="manageAddressDiv">
                  <input type="text" name="loc_address" class="form-control" placeholder="Endereço...">
                </div>
              </div>

              <div class="d-flex gap-2 mt-3 justify-content-end">
                <button type="button" class="btn btn-outline-secondary" data-bs-target="#addAvailabilityModal"
                  data-bs-toggle="modal">
                  <i class="fa fa-arrow-left me-1"></i> Voltar
                </button>
                <button type="submit" class="btn btn-success px-4">
                  <i class="fa fa-save me-1"></i> Salvar Local
                </button>
              </div>
            </form>

            <h6 class="text-muted mb-2">Locais Cadastrados</h6>
            <div class="list-group">
              {% for loc in my_locations %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div><strong>{{ loc.name }}</strong><small class="d-block text-muted">{{ loc.address if loc.address else
                    'Online' }}</small></div>
                <a href="{{ url_for('admin.delete_location', loc_id=loc.id) }}" class="text-danger"
                  onclick="return confirm('Excluir?')"><i class="fa fa-trash"></i></a>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="tab-pane fade" id="manage-slots">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="text-muted m-0">Disponíveis</h6>
              <button class="btn btn-sm btn-outline-secondary" data-bs-target="#addAvailabilityModal"
                data-bs-toggle="modal">Voltar</button>
            </div>
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Data/Hora</th>
                    <th>Local</th>
                    <th class="text-end">Ação</th>
                  </tr>
                </thead>
                <tbody>
                  {% for slot in open_slots %}
                  <tr>
                    <td>{{ slot.datetime_slot.strftime('%d/%m %H:%M') }}</td>
                    <td><small>{{ slot.location_rel.name }}</small></td>
                    <td class="text-end"><a href="{{ url_for('admin.delete_availability', slot_id=slot.id) }}"
                        class="text-danger"><i class="fa fa-trash"></i></a></td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="3" class="text-center py-4 text-muted">Nenhum horário livre.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="uploadResourceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold"><i class="fa fa-cloud-upload me-2"></i>Novo Material</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form action="{{ url_for('admin.upload_resource') }}" method="POST" enctype="multipart/form-data">

          <div class="mb-3">
            <label class="form-label fw-bold">Título do Material</label>
            <input type="text" name="title" class="form-control" placeholder="Ex: Canvas de Propósito" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Módulo Relacionado</label>
            <select name="module_name" class="form-select" required>
              <option value="" selected disabled>Selecione...</option>
              <option value="Módulo 1">Módulo 1</option>
              <option value="Módulo 2">Módulo 2</option>
              <option value="Módulo 3">Módulo 3</option>
              <option value="Módulo 4">Módulo 4</option>
              <option value="Módulo 5">Módulo 5</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold">Arquivo</label>
            <input type="file" name="file" class="form-control" accept=".pdf,.pptx,.doc,.docx,.xls,.xlsx" required>
            <div class="form-text small">Formatos aceitos: PDF, Office e Imagens.</div>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg fw-bold">
              <i class="fa fa-upload me-2"></i>Enviar Material
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="manageTasksModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold">Configurar Pré-tarefas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('admin.create_task') }}" method="POST" class="p-3 bg-light rounded border mb-4">
          <h6 class="text-primary fw-bold mb-3">Adicionar Nova Tarefa</h6>
          <div class="row g-3">
            <div class="col-md-3"> <label class="small text-muted fw-bold">Módulo</label>
              <select name="module_name" class="form-select form-select-sm" required>
                <option value="Módulo 1">Módulo 1</option>
                <option value="Módulo 2">Módulo 2</option>
                <option value="Módulo 3">Módulo 3</option>
                <option value="Módulo 4">Módulo 4</option>
                <option value="Módulo 5">Módulo 5</option>
              </select>
            </div>
            <div class="col-md-2"> <label class="small text-muted fw-bold">Ordem</label>
              <input type="number" name="order_index" class="form-control form-control-sm" value="1" min="1" required
                title="Número da sequência na tela">
            </div>
            <div class="col-md-7">
              <label class="small text-muted fw-bold">Título</label>
              <input type="text" name="title" class="form-control form-control-sm" placeholder="Ex: Teste de Perfil"
                required>
            </div>
            <div class="col-12">
              <input type="text" name="description" class="form-control form-control-sm"
                placeholder="Descrição curta (instruções)">
            </div>

            <div class="col-md-6">
              <label class="small text-muted fw-bold">Modelo para Download (Opcional)</label>
              <select name="resource_id" class="form-select form-select-sm">
                <option value="">-- Nenhum --</option>
                {% for res in resources %}
                <option value="{{ res.id }}">{{ res.title }} ({{ res.filename|truncate(20) }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="small text-muted">Link Externo (Opcional)</label>
              <input type="url" name="external_link" class="form-control form-control-sm" placeholder="https://...">
            </div>
            <div class="col-12 d-flex justify-content-between align-items-center mt-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="allow_upload" id="allowUploadCheck" checked>
                <label class="form-check-label small" for="allowUploadCheck">Exige envio de arquivo?</label>
              </div>
              <button type="submit" class="btn btn-sm btn-success px-4">Salvar Tarefa</button>
            </div>
          </div>
        </form>

        <h6 class="fw-bold mt-4">Tarefas Ativas</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Módulo</th>
                <th>Tarefa</th>
                <th>Tipo</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for t in module_tasks %}
              <tr>
                <td><span class="badge bg-light text-dark border">{{ t.module_name }}</span></td>
                <td>
                  <strong>{{ t.title }}</strong>
                  {% if t.order_index > 0 %}
                  <small class="text-muted ms-1">(Ordem: {{ t.order_index }})</small>
                  {% endif %}
                </td>
                <td>
                  {% if t.resource_id %}<i class="fa fa-file text-primary" title="Tem Arquivo"></i>{% endif %}
                  {% if t.external_link %}<i class="fa fa-link text-info" title="Link Externo"></i>{% endif %}
                  {% if t.allow_upload %}<i class="fa fa-upload text-success" title="Exige Upload"></i>{% endif %}
                </td>
                <td>
                  <button class="btn btn-link text-warning p-0 me-2" onclick="openEditTaskModal(this)"
                    data-id="{{ t.id }}" data-module="{{ t.module_name }}" data-title="{{ t.title }}"
                    data-desc="{{ t.description or '' }}" data-order="{{ t.order_index }}"
                    data-resource="{{ t.resource_id or '' }}" data-link="{{ t.external_link or '' }}"
                    data-upload="{{ 'true' if t.allow_upload else 'false' }}">
                    <i class="fa fa-pencil"></i>
                  </button>

                  <a href="{{ url_for('admin.delete_task_definition', task_id=t.id) }}" class="text-danger"
                    onclick="return confirm('Tem certeza?')"><i class="fa fa-trash"></i></a>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center text-muted">Nenhuma tarefa configurada.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title fw-bold"><i class="fa fa-pencil-square-o me-2"></i>Editar Tarefa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" data-bs-target="#manageTasksModal"
          data-bs-toggle="modal"></button>
      </div>
      <div class="modal-body bg-light">
        <form id="formEditTask" method="POST" class="p-2">

          <div class="row g-3">
            <div class="col-md-3">
              <label class="small text-muted fw-bold">Módulo</label>
              <select name="module_name" id="editTaskModule" class="form-select form-select-sm" required>
                <option value="Módulo 1">Módulo 1</option>
                <option value="Módulo 2">Módulo 2</option>
                <option value="Módulo 3">Módulo 3</option>
                <option value="Módulo 4">Módulo 4</option>
                <option value="Módulo 5">Módulo 5</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="small text-muted fw-bold">Ordem</label>
              <input type="number" name="order_index" id="editTaskOrder" class="form-control form-control-sm" min="1"
                required>
            </div>
            <div class="col-md-7">
              <label class="small text-muted fw-bold">Título</label>
              <input type="text" name="title" id="editTaskTitle" class="form-control form-control-sm" required>
            </div>
            <div class="col-12">
              <label class="small text-muted fw-bold">Descrição</label>
              <input type="text" name="description" id="editTaskDesc" class="form-control form-control-sm">
            </div>

            <div class="col-md-6">
              <label class="small text-muted fw-bold">Modelo (Opcional)</label>
              <select name="resource_id" id="editTaskResource" class="form-select form-select-sm">
                <option value="">-- Nenhum --</option>
                {% for res in resources %}
                <option value="{{ res.id }}">{{ res.title }} ({{ res.filename|truncate(20) }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="small text-muted fw-bold">Link Externo</label>
              <input type="url" name="external_link" id="editTaskLink" class="form-control form-control-sm">
            </div>

            <div class="col-12 d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="allow_upload" id="editTaskUpload">
                <label class="form-check-label small" for="editTaskUpload">Exige envio de arquivo?</label>
              </div>
              <div>
                <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-bs-target="#manageTasksModal"
                  data-bs-toggle="modal">Cancelar</button>
                <button type="submit" class="btn btn-sm btn-warning fw-bold px-4">Salvar Alterações</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 1. Recupera a última aba ativa do LocalStorage
    var activeTabId = localStorage.getItem('activeAdminTab');
    if (activeTabId) {
      var tabButton = document.querySelector(`button[data-bs-target="${activeTabId}"]`);
      if (tabButton) {
        var tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }

    // 2. Salva a aba sempre que o usuário clica/muda
    var tabEls = document.querySelectorAll('button[data-bs-toggle="pill"]');
    tabEls.forEach(function (tabEl) {
      tabEl.addEventListener('shown.bs.tab', function (event) {
        localStorage.setItem('activeAdminTab', event.target.getAttribute('data-bs-target'));
      });
    });
  });

  // Funções existentes de lógica de formulário
  function toggleManageAddress() {
    const type = document.getElementById('manageLocType').value;
    const div = document.getElementById('manageAddressDiv');
    div.style.display = (type === 'online') ? 'none' : 'block';
  }

  function handleLocationChange() {
    const select = document.getElementById('locationSelect');
    const value = select.options[select.selectedIndex].value;

    if (value === 'manage') {
      var myModal = new bootstrap.Modal(document.getElementById('managementModal'));
      myModal.show();
      select.value = "";
      return;
    }

    const dynamicFields = document.getElementById('dynamicFields');
    if (value) {
      dynamicFields.style.display = 'block';
      const type = select.options[select.selectedIndex].getAttribute('data-type');
      const address = select.options[select.selectedIndex].getAttribute('data-address');

      document.getElementById('onlineField').classList.toggle('d-none', type !== 'online');
      document.getElementById('presencialField').classList.toggle('d-none', type === 'online');
      if (type !== 'online') document.getElementById('addressDisplay').innerText = address || "Sem endereço.";
    } else {
      dynamicFields.style.display = 'none';
    }
  }

  // Função para abrir o Modal de Edição e preencher os dados
  function openEditTaskModal(btn) {
    // 1. Recupera dados do botão
    const id = btn.getAttribute('data-id');
    const module = btn.getAttribute('data-module');
    const title = btn.getAttribute('data-title');
    const desc = btn.getAttribute('data-desc');
    const order = btn.getAttribute('data-order');
    const resource = btn.getAttribute('data-resource');
    const link = btn.getAttribute('data-link');
    const upload = btn.getAttribute('data-upload') === 'true';

    // 2. Preenche os inputs do Modal de Edição
    document.getElementById('editTaskModule').value = module;
    document.getElementById('editTaskTitle').value = title;
    document.getElementById('editTaskDesc').value = desc;
    document.getElementById('editTaskOrder').value = order;
    document.getElementById('editTaskResource').value = resource; // Select selecionará automaticamente se o value existir
    document.getElementById('editTaskLink').value = link;
    document.getElementById('editTaskUpload').checked = upload;

    // 3. Define a URL de ação do formulário dinamicamente
    // Substitui o placeholder '0' pelo ID real
    const form = document.getElementById('formEditTask');
    // Atenção: A URL base deve corresponder à rota criada no routes.py
    form.action = "/admin/task/edit/" + id;

    // 4. Fecha o modal de lista e abre o de edição
    var listModalEl = document.getElementById('manageTasksModal');
    var listModal = bootstrap.Modal.getInstance(listModalEl);
    if (listModal) {
      listModal.hide();
    }

    var editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
    editModal.show();
  }
</script>

<style>
  .modal {
    z-index: 1055;
  }

  .modal-backdrop {
    z-index: 1050;
  }

  .modal.show+.modal-backdrop {
    z-index: 1060;
  }

  .modal.show+.modal {
    z-index: 1065;
  }
</style>

{% endblock %}
