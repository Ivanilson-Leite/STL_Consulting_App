{% extends "base_mentor.html" %}

{% block title %}STL Consulting - Módulo 1{% endblock %}

{% block content %}
<section id="section-home" class="text-light" aria-label="section"
  data-bgimage="url({{ url_for('static', filename='images/background/bg-event-1.jpg') }}) top"
  data-stellar-background-ratio=".2">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <div class="spacer-double"></div>
        <h4 class="s1 id-color">Mentoria</h4>
        <div class="spacer-10"></div>
        <h2 class="wow fadeInUp" data-wow-delay=".6s">Café com a STL</h2>
        <div class="spacer-double"></div>
      </div>
      <div class="col-lg-4 text-lg-right">
        {% if appointment %}
        <button class="btn-custom bg-success border-success" data-bs-toggle="modal" data-bs-target="#agendamentoModal">
          <i class="fa fa-check me-2"></i>Status Agendamento
        </button>
        {% else %}
        <button class="btn-custom" data-bs-toggle="modal" data-bs-target="#agendamentoModal">
          Agende Agora
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<div class="container mt-3">
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div
    class="alert alert-{{ 'success' if category == 'success' else 'danger' }} fade show shadow-sm py-2 px-3 rounded border-0 auto-dismiss"
    role="alert" style="font-size: 0.95rem;">
    <div class="d-flex align-items-center">
      <i class="fa {{ 'fa-check-circle' if category == 'success' else 'fa-exclamation-circle' }} me-2 fs-5"></i>
      <div>{{ message }}</div>
    </div>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}
</div>

<section id="section-training" data-bgimage="url({{ url_for('static', filename='images/background/bg-2.png') }}) bottom"
  class="relative">
  <div class="container">
    <div class="row">

      <div class="col-md-4">
        <h2>Módulo 1</h2>
        <div class="small-border sm-left"></div>

        <nav>
          <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <a class="nav-item nav-link active" id="nav-home-tab" data-bs-toggle="tab" href="#nav-home"
              role="tab">Descrição</a>
            <a class="nav-item nav-link" id="nav-profile-tab" data-bs-toggle="tab" href="#nav-profile"
              role="tab">Duração</a>
            <a class="nav-item nav-link" id="nav-contact-tab" data-bs-toggle="tab" href="#nav-contact"
              role="tab">Livros</a>
          </div>
        </nav>
        <div class="sm-spacer-double"></div>
        <div class="tab-content" id="nav-tabContent">
          <div class="tab-pane fade show active" id="nav-home" role="tabpanel">
            <p><br>Todo grande caminho começa com um primeiro passo, e o seu começa aqui. No “Café com a STL”, abrimos
              espaço para conexões genuínas.</p>
          </div>
          <div class="tab-pane fade" id="nav-profile" role="tabpanel">
            <p><br>Tarefas e leituras: 1h30min.<br>Mentoria: 50min.<br>Tempo do Módulo: <b>2h20min.</b></p>
          </div>
          <div class="tab-pane fade" id="nav-contact" role="tabpanel">
            <ul class="ul-style-2">
              <li><b>Comece pelo Porquê</b> - Simon Sinek</li>
              <li><b>O Poder do Hábito</b> - Charles Duhigg</li>
              <li><b>Essencialismo</b> - Greg McKeown</li>
            </ul>
          </div>
        </div>

        <div class="spacer-single"></div>

        <div class="sm-icon mb30">
          <i class="bg-color fa fa-map-marker"></i>
          <div class="si-inner">
            <h5>Onde?</h5>
            {{ appointment.location if appointment and appointment.location else 'A definir' }}
          </div>
        </div>
        <div class="sm-icon mb30">
          <i class="bg-color fa fa-calendar-check-o"></i>
          <div class="si-inner">
            <h5>Quando?</h5>
            {{ appointment.schedule_date if appointment and appointment.schedule_date else 'A definir' }}
          </div>
        </div>
        <div class="sm-icon mb30">
          <i class="bg-color fa fa-users"></i>
          <div class="si-inner">
            <h5>Status</h5>
            {% if appointment %}
            <span class="text-primary fw-bold">{{ appointment.status }}</span>
            {% else %}
            Aguardando agendamento.
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <h4>Temas e Pré-tarefas:</h4>

        <div class="table-responsive" style="min-height: 200px;">
          <table class="table table-hover align-middle w-100">
            <thead class="table-light">
              <tr>
                <th scope="col">Tópico</th>
                <th scope="col" class="text-nowrap text-end" style="width: 1%;">Status</th>
              </tr>
            </thead>
            <tbody>

              {% if tasks_data %}
              {% for item in tasks_data %}

              {% set has_actions = item.def.resource or item.def.external_link or item.def.allow_upload %}

              <tr {% if has_actions %} class="popover-trigger" tabindex="0" style="cursor: pointer;"
                data-bs-toggle="popover" data-bs-placement="bottom" data-bs-trigger="focus"
                title="Ações: {{ item.def.title }}" data-content-id="popover-hidden-{{ item.def.id }}" {% endif %}>

                <td>
                  <span class="fw-bold text-dark">{{ item.def.title }}</span>
                  <div class="text-muted small">
                    {{ item.def.description }}

                    {% if has_actions %}
                    {% if item.status == 'Concluído' %}
                    <div class="text-success mt-1"><i class="fa fa-check-circle me-1"></i> Enviado em {{
                      item.delivery.submitted_at.strftime('%d/%m às %H:%M') }}</div>
                    {% else %}
                    <div class="text-primary fst-italic mt-1"><i class="fa fa-mouse-pointer me-1"></i> Clique para
                      opções</div>
                    {% endif %}
                    {% endif %}
                  </div>
                </td>

                <td class="text-end">
                  {% if has_actions %}
                  {% if item.status == 'Concluído' %}
                  <span class="badge bg-success"><i class="fa fa-check me-1"></i> Concluído</span>
                  {% else %}
                  <span class="badge bg-warning text-dark">Pendente</span>
                  {% endif %}
                  {% else %}
                  <span class="badge text-dark">--</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="2" class="text-center text-muted py-4">Nenhuma tarefa configurada.</td>
              </tr>
              {% endif %}

            </tbody>
          </table>
        </div>

        <div class="spacer-single"></div>
        <h4>Mentor:</h4>
        <div class="profile-sm">
          <img src="{{ url_for('static', filename='images/team/1.jpg') }}" alt="">

          <h6>
            {% if current_user.my_mentor %}
            {{ current_user.my_mentor.username }}
            {% else %}
            Equipe STL
            {% endif %}
          </h6>
        </div>
      </div>
    </div>
  </div>
</section>

{% if tasks_data %}
{% for item in tasks_data %}
<div id="popover-hidden-{{ item.def.id }}" class="d-none">
  <div class="d-flex gap-2 justify-content-center align-items-center w-100 p-2">

    {% if item.def.external_link %}
    <a href="{{ item.def.external_link }}" target="_blank" class="btn btn-sm btn-outline-info"
      title="Abrir Link Externo">
      <i class="fa fa-external-link"></i>
    </a>
    {% endif %}

    {% if item.def.resource %}
    <a href="{{ url_for('mentor.download_resource', res_id=item.def.resource.id) }}"
      class="btn btn-sm btn-outline-primary" title="Baixar Modelo">
      <i class="fa fa-download"></i>
    </a>
    {% else %}
    <button class="btn btn-sm btn-light border text-muted" title="Nenhum arquivo modelo disponível" disabled>
      <i class="fa fa-ban"></i>
    </button>
    {% endif %}

    {% if item.def.allow_upload %}
    {% if item.status == 'Concluído' %}
    <form action="{{ url_for('mentor.delete_atividade') }}" method="POST" class="d-inline m-0 p-0"
      onsubmit="return confirm('Deseja excluir seu envio para enviar novamente?');">
      <input type="hidden" name="task_id" value="{{ item.def.id }}">
      <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir Envio"><i
          class="fa fa-trash"></i></button>
    </form>
    {% else %}
    <button type="button" class="btn btn-sm btn-outline-success" onclick="openUploadModal('{{ item.def.id }}')"
      title="Enviar Arquivo">
      <i class="fa fa-upload"></i>
    </button>
    {% endif %}
    {% endif %}
  </div>
</div>
{% endfor %}
{% endif %}

<div class="modal fade" id="agendamentoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">

      <div class="modal-header bg-light border-0">
        <h5 class="modal-title text-primary fw-bold">
          <i class="fa fa-calendar-check-o me-2"></i>Agendar Mentoria
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4">
        <form action="{{ url_for('mentor.schedule_appointment') }}" method="POST" id="formAgendamento">
          <input type="hidden" name="module_name" value="Módulo 1">
          <input type="hidden" id="schedule_slot_id" name="schedule_slot_id" required>

          <div class="mb-4">
            <label class="form-label fw-bold text-dark">Data e Local</label>
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="fa fa-clock-o text-primary"></i></span>
              <input type="text" class="form-control bg-white fw-bold text-muted" id="slot_display"
                placeholder="Clique para selecionar..." readonly style="cursor: pointer;" data-bs-toggle="modal"
                data-bs-target="#slotsModal">
              <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#slotsModal">
                Selecionar
              </button>
            </div>
          </div>

          <div class="mb-4">
            <label for="notes" class="form-label fw-bold text-dark">Observações</label>
            <textarea class="form-control bg-light" id="notes" name="notes"
              rows="3">{{ appointment.notes if appointment else '' }}</textarea>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg shadow-sm" id="btnConfirmar" disabled>
              {% if appointment %}Atualizar Agendamento{% else %}Confirmar Agendamento{% endif %}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="slotsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0">

      <div class="modal-header bg-primary text-white border-0">
        <h5 class="modal-title"><i class="fa fa-list-ul me-2"></i>Horários Disponíveis</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-toggle="modal"
          data-bs-target="#agendamentoModal"></button>
      </div>

      <div class="modal-body p-0">
        {% if available_slots %}
        <div class="list-group list-group-flush">
          {% for slot in available_slots %}
          <a href="#" class="list-group-item list-group-item-action p-3 slot-item"
            onclick="selectSlot('{{ slot.id }}', '{{ slot.datetime_slot.strftime('%d/%m/%Y às %H:%M') }}', '{{ slot.location_rel.name }}')">

            <div class="d-flex w-100 justify-content-between align-items-center">
              <div>
                <h6 class="mb-1 fw-bold text-dark">
                  <i class="fa fa-calendar me-2 text-primary"></i>{{ slot.datetime_slot.strftime('%d/%m/%Y') }}
                </h6>
                <small class="text-muted">
                  <i class="fa fa-clock-o me-1"></i>{{ slot.datetime_slot.strftime('%H:%M') }}
                </small>
              </div>

              <div class="text-end">
                {% if slot.location_rel.type == 'online' %}
                <span class="badge bg-info text-dark rounded-pill mb-1"><i
                    class="fa fa-video-camera me-1"></i>Online</span>
                {% else %}
                <span class="badge bg-warning text-dark rounded-pill mb-1"><i
                    class="fa fa-map-marker me-1"></i>Presencial</span>
                {% endif %}
                <div class="small text-muted"
                  style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  {{ slot.location_rel.name }}
                </div>
              </div>
            </div>
          </a>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center p-5">
          <i class="fa fa-calendar-times-o fa-3x text-muted mb-3"></i>
          <p class="text-muted">Nenhum horário disponível.</p>
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
            data-bs-target="#agendamentoModal">Voltar</button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="uploadAtividadeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-light border-0">
        <h5 class="modal-title m-0">
          <i class="fa fa-cloud-upload-alt me-2 text-primary"></i>Enviar Atividade
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4">
        <form action="{{ url_for('mentor.upload_atividade') }}" method="POST" enctype="multipart/form-data">

          <input type="hidden" id="upload_task_id" name="task_id" value="">

          <div class="mb-4 text-center">
            <div class="upload-icon-wrapper mb-2">
              <i class="fa fa-file-upload fa-3x text-muted"></i>
            </div>
            <p class="text-muted small mb-0">Formatos aceitos: <strong>.pptx</strong> e <strong>.pdf</strong></p>
          </div>

          <div class="mb-3">
            <label for="file" class="form-label fw-bold small text-uppercase text-muted">Selecione seu arquivo</label>
            <input class="form-control" type="file" id="file" name="file" accept=".pdf, .pptx" required>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-modal-action">
              Enviar Arquivo
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // 1. Função para abrir o modal de Upload com o ID correto
  function openUploadModal(taskId) {
    document.getElementById('upload_task_id').value = taskId;
    var myModal = new bootstrap.Modal(document.getElementById('uploadAtividadeModal'));
    myModal.show();
  }

  // 2. Função para selecionar horário
  function selectSlot(id, dateStr, location) {
    document.getElementById('schedule_slot_id').value = id;
    document.getElementById('slot_display').value = dateStr + " - " + location;
    document.getElementById('btnConfirmar').removeAttribute('disabled');

    var slotsModal = bootstrap.Modal.getInstance(document.getElementById('slotsModal'));
    slotsModal.hide();
    var mainModal = new bootstrap.Modal(document.getElementById('agendamentoModal'));
    mainModal.show();
  }

  document.addEventListener("DOMContentLoaded", function () {
    // 3. Inicializa os Popovers usando a técnica de conteúdo oculto
    // Seleciona todos os gatilhos com a classe .popover-trigger
    var popoverTriggerList = [].slice.call(document.querySelectorAll('.popover-trigger'));

    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      var contentId = popoverTriggerEl.getAttribute('data-content-id');
      var contentEl = document.getElementById(contentId);

      if (contentEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
          html: true,
          sanitize: false,
          trigger: 'focus', // Fecha ao clicar fora
          content: function () {
            // Retorna o HTML que está dentro da div oculta
            return contentEl.innerHTML;
          }
        });
      }
    });

    // Fecha alertas
    window.setTimeout(function () {
      $(".alert.auto-dismiss").fadeTo(500, 0).slideUp(500, function () { $(this).remove(); });
    }, 4000);
  });
</script>

<style>
  /* Garante que os modais fiquem sobre o backdrop */
  .modal {
    z-index: 1055;
  }

  .modal-backdrop {
    z-index: 1050;
  }

  /* Garante que o segundo modal fique sobre o primeiro */
  .modal.show+.modal-backdrop {
    z-index: 1060;
  }

  .modal.show+.modal {
    z-index: 1065;
  }

  /* Garante que o popover fique acima de tudo */
  .popover {
    z-index: 1070;
    max-width: 320px;
  }
</style>

{% endblock %}
